define("dojo/dnd/Manager",["dojo","dojo/dnd/common","dojo/dnd/autoscroll","dojo/dnd/Avatar"],function(a){a.declare("dojo.dnd.Manager",null,{constructor:function(){this.avatar=null;this.source=null;this.nodes=[];this.copy=true;this.target=null;this.canDropFlag=false;this.events=[];},OFFSET_X:16,OFFSET_Y:16,overSource:function(b){if(this.avatar){this.target=(b&&b.targetState!="Disabled")?b:null;this.canDropFlag=Boolean(this.target);this.avatar.update();}a.publish("/dnd/source/over",[b]);},outSource:function(b){if(this.avatar){if(this.target==b){this.target=null;this.canDropFlag=false;this.avatar.update();a.publish("/dnd/source/over",[null]);}}else{a.publish("/dnd/source/over",[null]);}},startDrag:function(d,b,f){this.source=d;this.nodes=b;this.copy=Boolean(f);this.avatar=this.makeAvatar();a.body().appendChild(this.avatar.node);a.publish("/dnd/start",[d,b,this.copy]);this.events=[a.connect(a.doc,"onmousemove",this,"onMouseMove"),a.connect(a.doc,"onmouseup",this,"onMouseUp"),a.connect(a.doc,"onkeydown",this,"onKeyDown"),a.connect(a.doc,"onkeyup",this,"onKeyUp"),a.connect(a.doc,"ondragstart",a.stopEvent),a.connect(a.body(),"onselectstart",a.stopEvent)];var e="dojoDnd"+(f?"Copy":"Move");a.addClass(a.body(),e);},canDrop:function(b){var c=Boolean(this.target&&b);if(this.canDropFlag!=c){this.canDropFlag=c;this.avatar.update();}},stopDrag:function(){a.removeClass(a.body(),["dojoDndCopy","dojoDndMove"]);a.forEach(this.events,a.disconnect);this.events=[];this.avatar.destroy();this.avatar=null;this.source=this.target=null;this.nodes=[];},makeAvatar:function(){return new a.dnd.Avatar(this);},updateAvatar:function(){this.avatar.update();},onMouseMove:function(d){var b=this.avatar;if(b){a.dnd.autoScrollNodes(d);var c=b.node.style;c.left=(d.pageX+this.OFFSET_X)+"px";c.top=(d.pageY+this.OFFSET_Y)+"px";var f=Boolean(this.source.copyState(a.isCopyKey(d)));if(this.copy!=f){this._setCopyStatus(f);}}},onMouseUp:function(b){if(this.avatar){if(this.target&&this.canDropFlag){var d=Boolean(this.source.copyState(a.isCopyKey(b))),c=[this.source,this.nodes,d,this.target,b];a.publish("/dnd/drop/before",c);a.publish("/dnd/drop",c);}else{a.publish("/dnd/cancel");}this.stopDrag();}},onKeyDown:function(b){if(this.avatar){switch(b.keyCode){case a.keys.CTRL:var c=Boolean(this.source.copyState(true));if(this.copy!=c){this._setCopyStatus(c);}break;case a.keys.ESCAPE:a.publish("/dnd/cancel");this.stopDrag();break;}}},onKeyUp:function(b){if(this.avatar&&b.keyCode==a.keys.CTRL){var c=Boolean(this.source.copyState(false));if(this.copy!=c){this._setCopyStatus(c);}}},_setCopyStatus:function(b){this.copy=b;this.source._markDndStatus(this.copy);this.updateAvatar();a.replaceClass(a.body(),"dojoDnd"+(this.copy?"Copy":"Move"),"dojoDnd"+(this.copy?"Move":"Copy"));}});a.dnd._manager=null;a.dnd.manager=function(){if(!a.dnd._manager){a.dnd._manager=new a.dnd.Manager();}return a.dnd._manager;};return a.dnd.Manager;});