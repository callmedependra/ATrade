define("dojo/dnd/Source",["dojo","dojo/dnd/Selector","dojo/dnd/Manager"],function(a){a.declare("dojo.dnd.Source",a.dnd.Selector,{isSource:true,horizontal:false,copyOnly:false,selfCopy:false,selfAccept:true,skipForm:false,withHandles:false,autoSync:false,delay:0,accept:["text"],generateText:true,constructor:function(d,e){a.mixin(this,a.mixin({},e));var c=this.accept;if(c.length){this.accept={};for(var b=0;b<c.length;++b){this.accept[c[b]]=1;}}this.isDragging=false;this.mouseDown=false;this.targetAnchor=null;this.targetBox=null;this.before=true;this._lastX=0;this._lastY=0;this.sourceState="";if(this.isSource){a.addClass(this.node,"dojoDndSource");}this.targetState="";if(this.accept){a.addClass(this.node,"dojoDndTarget");}if(this.horizontal){a.addClass(this.node,"dojoDndHorizontal");}this.topics=[a.subscribe("/dnd/source/over",this,"onDndSourceOver"),a.subscribe("/dnd/start",this,"onDndStart"),a.subscribe("/dnd/drop",this,"onDndDrop"),a.subscribe("/dnd/cancel",this,"onDndCancel")];},checkAcceptance:function(g,c){if(this==g){return !this.copyOnly||this.selfAccept;}for(var e=0;e<c.length;++e){var f=g.getItem(c[e].id).type;var b=false;for(var d=0;d<f.length;++d){if(f[d] in this.accept){b=true;break;}}if(!b){return false;}}return true;},copyState:function(b,c){if(b){return true;}if(arguments.length<2){c=this==a.dnd.manager().target;}if(c){if(this.copyOnly){return this.selfCopy;}}else{return this.copyOnly;}return false;},destroy:function(){a.dnd.Source.superclass.destroy.call(this);a.forEach(this.topics,a.unsubscribe);this.targetAnchor=null;},markupFactory:function(c,b){c._skipStartup=true;return new a.dnd.Source(b,c);},onMouseMove:function(f){if(this.isDragging&&this.targetState=="Disabled"){return;}a.dnd.Source.superclass.onMouseMove.call(this,f);var b=a.dnd.manager();if(!this.isDragging){if(this.mouseDown&&this.isSource&&(Math.abs(f.pageX-this._lastX)>this.delay||Math.abs(f.pageY-this._lastY)>this.delay)){var c=this.getSelectedNodes();if(c.length){b.startDrag(this,c,this.copyState(a.isCopyKey(f),true));}}}if(this.isDragging){var d=false;if(this.current){if(!this.targetBox||this.targetAnchor!=this.current){this.targetBox=a.position(this.current,true);}if(this.horizontal){d=(f.pageX-this.targetBox.x)<(this.targetBox.w/2);}else{d=(f.pageY-this.targetBox.y)<(this.targetBox.h/2);}}if(this.current!=this.targetAnchor||d!=this.before){this._markTargetAnchor(d);b.canDrop(!this.current||b.source!=this||!(this.current.id in this.selection));}}},onMouseDown:function(b){if(!this.mouseDown&&this._legalMouseDown(b)&&(!this.skipForm||!a.dnd.isFormElement(b))){this.mouseDown=true;this._lastX=b.pageX;this._lastY=b.pageY;a.dnd.Source.superclass.onMouseDown.call(this,b);}},onMouseUp:function(b){if(this.mouseDown){this.mouseDown=false;a.dnd.Source.superclass.onMouseUp.call(this,b);}},onDndSourceOver:function(c){if(this!=c){this.mouseDown=false;if(this.targetAnchor){this._unmarkTargetAnchor();}}else{if(this.isDragging){var b=a.dnd.manager();b.canDrop(this.targetState!="Disabled"&&(!this.current||b.source!=this||!(this.current.id in this.selection)));}}},onDndStart:function(c,b,e){if(this.autoSync){this.sync();}if(this.isSource){this._changeState("Source",this==c?(e?"Copied":"Moved"):"");}var d=this.accept&&this.checkAcceptance(c,b);this._changeState("Target",d?"":"Disabled");if(this==c){a.dnd.manager().overSource(this);}this.isDragging=true;},onDndDrop:function(c,b,e,d){if(this==d){this.onDrop(c,b,e);}this.onDndCancel();},onDndCancel:function(){if(this.targetAnchor){this._unmarkTargetAnchor();this.targetAnchor=null;}this.before=true;this.isDragging=false;this.mouseDown=false;this._changeState("Source","");this._changeState("Target","");},onDrop:function(c,b,d){if(this!=c){this.onDropExternal(c,b,d);}else{this.onDropInternal(b,d);}},onDropExternal:function(d,b,e){var c=this._normalizedCreator;if(this.creator){this._normalizedCreator=function(f,g){return c.call(this,d.getItem(f.id).data,g);};}else{if(e){this._normalizedCreator=function(g,h){var f=d.getItem(g.id);var i=g.cloneNode(true);i.id=a.dnd.getUniqueId();return{node:i,data:f.data,type:f.type};};}else{this._normalizedCreator=function(g,h){var f=d.getItem(g.id);d.delItem(g.id);return{node:g,data:f.data,type:f.type};};}}this.selectNone();if(!e&&!this.creator){d.selectNone();}this.insertNodes(true,b,this.before,this.current);if(!e&&this.creator){d.deleteSelectedNodes();}this._normalizedCreator=c;},onDropInternal:function(b,d){var c=this._normalizedCreator;if(this.current&&this.current.id in this.selection){return;}if(d){if(this.creator){this._normalizedCreator=function(e,f){return c.call(this,this.getItem(e.id).data,f);};}else{this._normalizedCreator=function(f,g){var e=this.getItem(f.id);var h=f.cloneNode(true);h.id=a.dnd.getUniqueId();return{node:h,data:e.data,type:e.type};};}}else{if(!this.current){return;}this._normalizedCreator=function(f,g){var e=this.getItem(f.id);return{node:f,data:e.data,type:e.type};};}this._removeSelection();this.insertNodes(true,b,this.before,this.current);this._normalizedCreator=c;},onDraggingOver:function(){},onDraggingOut:function(){},onOverEvent:function(){a.dnd.Source.superclass.onOverEvent.call(this);a.dnd.manager().overSource(this);if(this.isDragging&&this.targetState!="Disabled"){this.onDraggingOver();}},onOutEvent:function(){a.dnd.Source.superclass.onOutEvent.call(this);a.dnd.manager().outSource(this);if(this.isDragging&&this.targetState!="Disabled"){this.onDraggingOut();}},_markTargetAnchor:function(b){if(this.current==this.targetAnchor&&this.before==b){return;}if(this.targetAnchor){this._removeItemClass(this.targetAnchor,this.before?"Before":"After");}this.targetAnchor=this.current;this.targetBox=null;this.before=b;if(this.targetAnchor){this._addItemClass(this.targetAnchor,this.before?"Before":"After");}},_unmarkTargetAnchor:function(){if(!this.targetAnchor){return;}this._removeItemClass(this.targetAnchor,this.before?"Before":"After");this.targetAnchor=null;this.targetBox=null;this.before=true;},_markDndStatus:function(b){this._changeState("Source",b?"Copied":"Moved");},_legalMouseDown:function(c){if(!a.mouseButtons.isLeft(c)){return false;}if(!this.withHandles){return true;}for(var b=c.target;b&&b!==this.node;b=b.parentNode){if(a.hasClass(b,"dojoDndHandle")){return true;}if(a.hasClass(b,"dojoDndItem")||a.hasClass(b,"dojoDndIgnore")){break;}}return false;}});a.declare("dojo.dnd.Target",a.dnd.Source,{constructor:function(b,c){this.isSource=false;a.removeClass(this.node,"dojoDndSource");},markupFactory:function(c,b){c._skipStartup=true;return new a.dnd.Target(b,c);}});a.declare("dojo.dnd.AutoSource",a.dnd.Source,{constructor:function(b,c){this.autoSync=true;},markupFactory:function(c,b){c._skipStartup=true;return new a.dnd.AutoSource(b,c);}});return a.dnd.Source;});