define("dijit/_editor/plugins/EnterKeyHandling",["dojo","dijit","dojo/window","dijit/_editor/_Plugin","dijit/_editor/range"],function(a,b){a.declare("dijit._editor.plugins.EnterKeyHandling",b._editor._Plugin,{blockNodeForEnter:"BR",constructor:function(c){if(c){if("blockNodeForEnter" in c){c.blockNodeForEnter=c.blockNodeForEnter.toUpperCase();}a.mixin(this,c);}},setEditor:function(d){if(this.editor===d){return;}this.editor=d;if(this.blockNodeForEnter=="BR"){this.editor.customUndo=true;d.onLoadDeferred.addCallback(a.hitch(this,function(e){this.connect(d.document,"onkeypress",function(g){if(g.charOrCode==a.keys.ENTER){var f=a.mixin({},g);f.shiftKey=true;if(!this.handleEnterKey(f)){a.stopEvent(g);}}});return e;}));}else{if(this.blockNodeForEnter){var c=a.hitch(this,this.handleEnterKey);d.addKeyHandler(13,0,0,c);d.addKeyHandler(13,0,1,c);this.connect(this.editor,"onKeyPressed","onKeyPressed");}}},onKeyPressed:function(i){if(this._checkListLater){if(a.withGlobal(this.editor.window,"isCollapsed",b)){var h=a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,["LI"]);if(!h){b._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var j=a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,[this.blockNodeForEnter]);if(j){j.innerHTML=this.bogusHtmlContent;if(a.isIE){var f=this.editor.document.selection.createRange();f.move("character",-1);f.select();}}else{console.error("onKeyPressed: Cannot find the new block node");}}else{if(a.isMoz){if(h.parentNode.parentNode.nodeName=="LI"){h=h.parentNode.parentNode;}}var d=h.firstChild;if(d&&d.nodeType==1&&(d.nodeName=="UL"||d.nodeName=="OL")){h.insertBefore(d.ownerDocument.createTextNode("\xA0"),d);var g=b.range.create(this.editor.window);g.setStart(h.firstChild,0);var c=b.range.getSelection(this.editor.window,true);c.removeAllRanges();c.addRange(g);}}}this._checkListLater=false;}if(this._pressedEnterInBlock){if(this._pressedEnterInBlock.previousSibling){this.removeTrailingBr(this._pressedEnterInBlock.previousSibling);}delete this._pressedEnterInBlock;}},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(x){var E,s,f,B,u,h,F=this.editor.document,A,m,t;if(x.shiftKey){var q=a.withGlobal(this.editor.window,"getParentElement",b._editor.selection);var w=b.range.getAncestor(q,this.blockNodes);if(w){if(w.tagName=="LI"){return true;}E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);if(!s.collapsed){s.deleteContents();E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);}if(b.range.atBeginningOfContainer(w,s.startContainer,s.startOffset)){A=F.createElement("br");f=b.range.create(this.editor.window);w.insertBefore(A,w.firstChild);f.setStartBefore(A.nextSibling);E.removeAllRanges();E.addRange(f);}else{if(b.range.atEndOfContainer(w,s.startContainer,s.startOffset)){f=b.range.create(this.editor.window);A=F.createElement("br");w.appendChild(A);w.appendChild(F.createTextNode("\xA0"));f.setStart(w.lastChild,0);E.removeAllRanges();E.addRange(f);}else{m=s.startContainer;if(m&&m.nodeType==3){t=m.nodeValue;a.withGlobal(this.editor.window,function(){B=F.createTextNode(t.substring(0,s.startOffset));u=F.createTextNode(t.substring(s.startOffset));h=F.createElement("br");if(u.nodeValue==""&&a.isWebKit){u=F.createTextNode("\xA0");}a.place(B,m,"after");a.place(h,B,"after");a.place(u,h,"after");a.destroy(m);f=b.range.create(a.gobal);f.setStart(u,0);E.removeAllRanges();E.addRange(f);});return false;}return true;}}}else{E=b.range.getSelection(this.editor.window);if(E.rangeCount){s=E.getRangeAt(0);if(s&&s.startContainer){if(!s.collapsed){s.deleteContents();E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);}m=s.startContainer;if(m&&m.nodeType==3){a.withGlobal(this.editor.window,a.hitch(this,function(){var e=false;var G=s.startOffset;if(m.length<G){D=this._adjustNodeAndOffset(m,G);m=D.node;G=D.offset;}t=m.nodeValue;B=F.createTextNode(t.substring(0,G));u=F.createTextNode(t.substring(G));h=F.createElement("br");if(!u.length){u=F.createTextNode("\xA0");e=true;}if(B.length){a.place(B,m,"after");}else{B=m;}a.place(h,B,"after");a.place(u,h,"after");a.destroy(m);f=b.range.create(a.gobal);f.setStart(u,0);f.setEnd(u,u.length);E.removeAllRanges();E.addRange(f);if(e&&!a.isWebKit){b._editor.selection.remove();}else{b._editor.selection.collapse(true);}}));}else{a.withGlobal(this.editor.window,a.hitch(this,function(){var G=F.createElement("br");m.appendChild(G);var e=F.createTextNode("\xA0");m.appendChild(e);f=b.range.create(a.global);f.setStart(e,0);f.setEnd(e,e.length);E.removeAllRanges();E.addRange(f);b._editor.selection.collapse(true);}));}}}else{b._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");}}return false;}var c=true;E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);if(!s.collapsed){s.deleteContents();E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);}var o=b.range.getBlockAncestor(s.endContainer,null,this.editor.editNode);var p=o.blockNode;if((this._checkListLater=(p&&(p.nodeName=="LI"||p.parentNode.nodeName=="LI")))){if(a.isMoz){this._pressedEnterInBlock=p;}if(/^(\s|&nbsp;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|\xA0)<\/span>)?(<br>)?$/.test(p.innerHTML)){p.innerHTML="";if(a.isWebKit){f=b.range.create(this.editor.window);f.setStart(p,0);E.removeAllRanges();E.addRange(f);}this._checkListLater=false;}return true;}if(!o.blockNode||o.blockNode===this.editor.editNode){try{b._editor.RichText.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);}catch(l){}o={blockNode:a.withGlobal(this.editor.window,"getAncestorElement",b._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode};if(o.blockNode){if(o.blockNode!=this.editor.editNode&&(!(o.blockNode.textContent||o.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)){this.removeTrailingBr(o.blockNode);return false;}}else{o.blockNode=this.editor.editNode;}E=b.range.getSelection(this.editor.window);s=E.getRangeAt(0);}var z=F.createElement(this.blockNodeForEnter);z.innerHTML=this.bogusHtmlContent;this.removeTrailingBr(o.blockNode);var j=s.endOffset;var v=s.endContainer;if(v.length<j){var D=this._adjustNodeAndOffset(v,j);v=D.node;j=D.offset;}if(b.range.atEndOfContainer(o.blockNode,v,j)){if(o.blockNode===o.blockContainer){o.blockNode.appendChild(z);}else{a.place(z,o.blockNode,"after");}c=false;f=b.range.create(this.editor.window);f.setStart(z,0);E.removeAllRanges();E.addRange(f);if(this.editor.height){a.window.scrollIntoView(z);}}else{if(b.range.atBeginningOfContainer(o.blockNode,s.startContainer,s.startOffset)){a.place(z,o.blockNode,o.blockNode===o.blockContainer?"first":"before");if(z.nextSibling&&this.editor.height){f=b.range.create(this.editor.window);f.setStart(z.nextSibling,0);E.removeAllRanges();E.addRange(f);a.window.scrollIntoView(z.nextSibling);}c=false;}else{if(o.blockNode===o.blockContainer){o.blockNode.appendChild(z);}else{a.place(z,o.blockNode,"after");}c=false;if(o.blockNode.style){if(z.style){if(o.blockNode.style.cssText){z.style.cssText=o.blockNode.style.cssText;}}}m=s.startContainer;var i;if(m&&m.nodeType==3){var n,r;j=s.endOffset;if(m.length<j){D=this._adjustNodeAndOffset(m,j);m=D.node;j=D.offset;}t=m.nodeValue;B=F.createTextNode(t.substring(0,j));u=F.createTextNode(t.substring(j,t.length));a.place(B,m,"before");a.place(u,m,"after");a.destroy(m);var y=B.parentNode;while(y!==o.blockNode){var k=y.tagName;var g=F.createElement(k);if(y.style){if(g.style){if(y.style.cssText){g.style.cssText=y.style.cssText;}}}if(y.tagName==="FONT"){if(y.color){g.color=y.color;}if(y.face){g.face=y.face;}if(y.size){g.size=y.size;}}n=u;while(n){r=n.nextSibling;g.appendChild(n);n=r;}a.place(g,y,"after");B=y;u=g;y=y.parentNode;}n=u;if(n.nodeType==1||(n.nodeType==3&&n.nodeValue)){z.innerHTML="";}i=n;while(n){r=n.nextSibling;z.appendChild(n);n=r;}}f=b.range.create(this.editor.window);var d;var C=i;if(this.blockNodeForEnter!=="BR"){while(C){d=C;r=C.firstChild;C=r;}if(d&&d.parentNode){z=d.parentNode;f.setStart(z,0);E.removeAllRanges();E.addRange(f);if(this.editor.height){b.scrollIntoView(z);}if(a.isMoz){this._pressedEnterInBlock=o.blockNode;}}else{c=true;}}else{f.setStart(z,0);E.removeAllRanges();E.addRange(f);if(this.editor.height){b.scrollIntoView(z);}if(a.isMoz){this._pressedEnterInBlock=o.blockNode;}}}}return c;},_adjustNodeAndOffset:function(d,e){while(d.length<e&&d.nextSibling&&d.nextSibling.nodeType==3){e=e-d.length;d=d.nextSibling;}var c={node:d,offset:e};return c;},removeTrailingBr:function(d){var c=/P|DIV|LI/i.test(d.tagName)?d:b._editor.selection.getParentOfType(d,["P","DIV","LI"]);if(!c){return;}if(c.lastChild){if((c.childNodes.length>1&&c.lastChild.nodeType==3&&/^[\s\xAD]*$/.test(c.lastChild.nodeValue))||c.lastChild.tagName=="BR"){a.destroy(c.lastChild);}}if(!c.childNodes.length){c.innerHTML=this.bogusHtmlContent;}}});return b._editor.plugins.EnterKeyHandling;});