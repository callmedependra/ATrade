define("dijit/form/ComboBox",["dojo","dijit","text!dijit/form/templates/DropDownBox.html","dojo/window","dojo/regexp","dojo/data/util/simpleFetch","dojo/data/util/filter","dijit/_CssStateMixin","dijit/form/_FormWidget","dijit/form/ValidationTextBox","dijit/_HasDropDown","i18n!dijit/form/nls/ComboBox"],function(a,b){a.declare("dijit.form.ComboBoxMixin",b._HasDropDown,{item:null,pageSize:Infinity,store:null,fetchProperties:{},query:{},autoComplete:true,highlightMatch:"first",searchDelay:100,searchAttr:"name",labelAttr:"",labelType:"text",queryExpr:"${0}*",ignoreCase:true,hasDownArrow:true,templateString:a.cache("dijit.form","templates/DropDownBox.html"),baseClass:"dijitTextBox dijitComboBox",dropDownClass:"dijit.form._ComboBoxMenu",cssStateNodes:{_buttonNode:"dijitDownArrowButton"},maxHeight:-1,_stopClickEvents:false,_getCaretPos:function(c){var h=0;if(typeof(c.selectionStart)=="number"){h=c.selectionStart;}else{if(a.isIE){var f=a.doc.selection.createRange().duplicate();var d=c.createTextRange();f.move("character",0);d.move("character",0);try{d.setEndPoint("EndToEnd",f);h=String(d.text).replace(/\r/g,"").length;}catch(g){}}}return h;},_setCaretPos:function(d,c){c=parseInt(c);b.selectInputText(d,c,c);},_setDisabledAttr:function(c){this.inherited(arguments);b.setWaiState(this.domNode,"disabled",c);},_abortQuery:function(){if(this.searchTimer){clearTimeout(this.searchTimer);this.searchTimer=null;}if(this._fetchHandle){if(this._fetchHandle.abort){this._fetchHandle.abort();}this._fetchHandle=null;}},_onInput:function(c){if(!this.searchTimer&&(c.type=="paste"||c.type=="input")&&this._lastInput!=this.textbox.value){this.searchTimer=setTimeout(a.hitch(this,function(){this._onKey({charOrCode:229});}),100);}this.inherited(arguments);},_onKey:function(c){var g=c.charOrCode;if(c.altKey||((c.ctrlKey||c.metaKey)&&(g!="x"&&g!="v"))||g==a.keys.SHIFT){return;}var f=false;var h=this.dropDown;var e=a.keys;var i=null;this._prev_key_backspace=false;this._abortQuery();this.inherited(arguments);if(this._opened){i=h.getHighlightedOption();}switch(g){case e.PAGE_DOWN:case e.DOWN_ARROW:case e.PAGE_UP:case e.UP_ARROW:if(this._opened){this._announceOption(i);}a.stopEvent(c);break;case e.ENTER:if(i){if(i==h.nextButton){this._nextSearch(1);a.stopEvent(c);break;}else{if(i==h.previousButton){this._nextSearch(-1);a.stopEvent(c);break;}}}else{this._setBlurValue();this._setCaretPos(this.focusNode,this.focusNode.value.length);}if(this._opened||this._fetchHandle){c.preventDefault();}case e.TAB:var d=this.get("displayedValue");if(h&&(d==h._messages.previousMessage||d==h._messages.nextMessage)){break;}if(i){this._selectOption();}if(this._opened){this._lastQuery=null;this.closeDropDown();}break;case" ":if(i){a.stopEvent(c);this._selectOption();this.closeDropDown();}else{f=true;}break;case e.DELETE:case e.BACKSPACE:this._prev_key_backspace=true;f=true;break;default:f=typeof g=="string"||g==229;}if(f){this.item=undefined;this.searchTimer=setTimeout(a.hitch(this,"_startSearchFromInput"),1);}},_autoCompleteText:function(e){var c=this.focusNode;b.selectInputText(c,c.value.length);var d=this.ignoreCase?"toLowerCase":"substr";if(e[d](0).indexOf(this.focusNode.value[d](0))==0){var f=this._getCaretPos(c);if((f+1)>c.value.length){c.value=e;b.selectInputText(c,f);}}else{c.value=e;b.selectInputText(c);}},_openResultList:function(d,e){this._fetchHandle=null;if(this.disabled||this.readOnly||(e.query[this.searchAttr]!=this._lastQuery)){return;}var f=this.dropDown._highlighted_option&&a.hasClass(this.dropDown._highlighted_option,"dijitMenuItemSelected");this.dropDown.clearResultList();if(!d.length&&!this._maxOptions){this.closeDropDown();return;}e._maxOptions=this._maxOptions;var c=this.dropDown.createOptions(d,e,a.hitch(this,"_getMenuLabelFromItem"));this._showResultList();if(e.direction){if(1==e.direction){this.dropDown.highlightFirstOption();}else{if(-1==e.direction){this.dropDown.highlightLastOption();}}if(f){this._announceOption(this.dropDown.getHighlightedOption());}}else{if(this.autoComplete&&!this._prev_key_backspace&&!/^[*]+$/.test(e.query[this.searchAttr])){this._announceOption(c[1]);}}},_showResultList:function(){this.closeDropDown(true);this.displayMessage("");this.openDropDown();b.setWaiState(this.domNode,"expanded","true");},loadDropDown:function(c){this._startSearchAll();},isLoaded:function(){return false;},closeDropDown:function(){this._abortQuery();if(this._opened){this.inherited(arguments);b.setWaiState(this.domNode,"expanded","false");b.removeWaiState(this.focusNode,"activedescendant");}},_setBlurValue:function(){var c=this.get("displayedValue");var d=this.dropDown;if(d&&(c==d._messages.previousMessage||c==d._messages.nextMessage)){this._setValueAttr(this._lastValueReported,true);}else{if(typeof this.item=="undefined"){this.item=null;this.set("displayedValue",c);}else{if(this.value!=this._lastValueReported){b.form._FormValueWidget.prototype._setValueAttr.call(this,this.value,true);}this._refreshState();}}},_onBlur:function(){this.closeDropDown();this.inherited(arguments);},_setItemAttr:function(e,d,c){if(!c){c=this.store.getValue(e,this.searchAttr);}var f=this._getValueField()!=this.searchAttr?this.store.getIdentity(e):c;this._set("item",e);b.form.ComboBox.superclass._setValueAttr.call(this,f,d,c);},_announceOption:function(c){if(!c){return;}var d;if(c==this.dropDown.nextButton||c==this.dropDown.previousButton){d=c.innerHTML;this.item=undefined;this.value="";}else{d=this.store.getValue(c.item,this.searchAttr).toString();this.set("item",c.item,false,d);}this.focusNode.value=this.focusNode.value.substring(0,this._lastInput.length);b.setWaiState(this.focusNode,"activedescendant",a.attr(c,"id"));this._autoCompleteText(d);},_selectOption:function(c){if(c){this._announceOption(c.target);}this.closeDropDown();this._setCaretPos(this.focusNode,this.focusNode.value.length);b.form._FormValueWidget.prototype._setValueAttr.call(this,this.value,true);},_startSearchAll:function(){this._startSearch("");},_startSearchFromInput:function(){this._startSearch(this.focusNode.value.replace(/([\\\*\?])/g,"\\$1"));},_getQueryString:function(c){return a.string.substitute(this.queryExpr,[c]);},_startSearch:function(e){if(!this.dropDown){var d=this.id+"_popup",c=a.getObject(this.dropDownClass,false);this.dropDown=new c({onChange:a.hitch(this,this._selectOption),id:d,dir:this.dir});b.removeWaiState(this.focusNode,"activedescendant");b.setWaiState(this.textbox,"owns",d);}var f=a.clone(this.query);this._lastInput=e;this._lastQuery=f[this.searchAttr]=this._getQueryString(e);this.searchTimer=setTimeout(a.hitch(this,function(h,j){this.searchTimer=null;var g={queryOptions:{ignoreCase:this.ignoreCase,deep:true},query:h,onBegin:a.hitch(this,"_setMaxOptions"),onComplete:a.hitch(this,"_openResultList"),onError:function(k){j._fetchHandle=null;console.error("dijit.form.ComboBox: "+k);j.closeDropDown();},start:0,count:this.pageSize};a.mixin(g,j.fetchProperties);this._fetchHandle=j.store.fetch(g);var i=function(k,l){k.start+=k.count*l;k.direction=l;this._fetchHandle=this.store.fetch(k);this.focus();};this._nextSearch=this.dropDown.onPage=a.hitch(this,i,this._fetchHandle);},f,this),this.searchDelay);},_setMaxOptions:function(c,d){this._maxOptions=c;},_getValueField:function(){return this.searchAttr;},constructor:function(){this.query={};this.fetchProperties={};},postMixInProperties:function(){if(!this.store){var d=this.srcNodeRef;this.store=new b.form._ComboBoxDataStore(d);if(!("value" in this.params)){var e=(this.item=this.store.fetchSelectedItem());if(e){var c=this._getValueField();this.value=this.store.getValue(e,c);}}}this.inherited(arguments);},postCreate:function(){var c=a.query('label[for="'+this.id+'"]');if(c.length){c[0].id=(this.id+"_label");b.setWaiState(this.domNode,"labelledby",c[0].id);}this.inherited(arguments);},_setHasDownArrowAttr:function(c){this.hasDownArrow=c;this._buttonNode.style.display=c?"":"none";},_getMenuLabelFromItem:function(e){var d=this.labelFunc(e,this.store),c=this.labelType;if(this.highlightMatch!="none"&&this.labelType=="text"&&this._lastInput){d=this.doHighlight(d,this._escapeHtml(this._lastInput));c="html";}return{html:c=="html",label:d};},doHighlight:function(d,f){var c=(this.ignoreCase?"i":"")+(this.highlightMatch=="all"?"g":""),e=this.queryExpr.indexOf("${0}");f=a.regexp.escapeString(f);return this._escapeHtml(d).replace(new RegExp((e==0?"^":"")+"("+f+")"+(e==(this.queryExpr.length-4)?"$":""),c),'<span class="dijitComboBoxHighlightMatch">$1</span>');},_escapeHtml:function(c){c=String(c).replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;");return c;},reset:function(){this.item=null;this.inherited(arguments);},labelFunc:function(d,c){return c.getValue(d,this.labelAttr||this.searchAttr).toString();}});a.declare("dijit.form._ComboBoxMenu",[b._Widget,b._Templated,b._CssStateMixin],{templateString:"<ul class='dijitReset dijitMenu' dojoAttachEvent='onmousedown:_onMouseDown,onmouseup:_onMouseUp,onmouseover:_onMouseOver,onmouseout:_onMouseOut' style='overflow: \"auto\"; overflow-x: \"hidden\";'><li class='dijitMenuItem dijitMenuPreviousButton' dojoAttachPoint='previousButton' role='option'></li><li class='dijitMenuItem dijitMenuNextButton' dojoAttachPoint='nextButton' role='option'></li></ul>",_messages:null,baseClass:"dijitComboBoxMenu",postMixInProperties:function(){this.inherited(arguments);this._messages=a.i18n.getLocalization("dijit.form","ComboBox",this.lang);},buildRendering:function(){this.inherited(arguments);this.previousButton.innerHTML=this._messages.previousMessage;this.nextButton.innerHTML=this._messages.nextMessage;},_setValueAttr:function(c){this.value=c;this.onChange(c);},onChange:function(c){},onPage:function(c){},onClose:function(){this._blurOptionNode();},_createOption:function(e,d){var f=a.create("li",{"class":"dijitReset dijitMenuItem"+(this.isLeftToRight()?"":" dijitMenuItemRtl"),role:"option"});var c=d(e);if(c.html){f.innerHTML=c.label;}else{f.appendChild(a.doc.createTextNode(c.label));}if(f.innerHTML==""){f.innerHTML="&nbsp;";}f.item=e;return f;},createOptions:function(e,f,d){this.previousButton.style.display=(f.start==0)?"none":"";a.attr(this.previousButton,"id",this.id+"_prev");a.forEach(e,function(h,g){var j=this._createOption(h,d);a.attr(j,"id",this.id+g);this.domNode.insertBefore(j,this.nextButton);},this);var c=false;if(f._maxOptions&&f._maxOptions!=-1){if((f.start+f.count)<f._maxOptions){c=true;}else{if((f.start+f.count)>f._maxOptions&&f.count==e.length){c=true;}}}else{if(f.count==e.length){c=true;}}this.nextButton.style.display=c?"":"none";a.attr(this.nextButton,"id",this.id+"_next");return this.domNode.childNodes;},clearResultList:function(){while(this.domNode.childNodes.length>2){this.domNode.removeChild(this.domNode.childNodes[this.domNode.childNodes.length-2]);}this._blurOptionNode();},_onMouseDown:function(c){a.stopEvent(c);},_onMouseUp:function(c){if(c.target===this.domNode||!this._highlighted_option){return;}else{if(c.target==this.previousButton){this._blurOptionNode();this.onPage(-1);}else{if(c.target==this.nextButton){this._blurOptionNode();this.onPage(1);}else{var d=c.target;while(!d.item){d=d.parentNode;}this._setValueAttr({target:d},true);}}}},_onMouseOver:function(c){if(c.target===this.domNode){return;}var d=c.target;if(!(d==this.previousButton||d==this.nextButton)){while(!d.item){d=d.parentNode;}}this._focusOptionNode(d);},_onMouseOut:function(c){if(c.target===this.domNode){return;}this._blurOptionNode();},_focusOptionNode:function(c){if(this._highlighted_option!=c){this._blurOptionNode();this._highlighted_option=c;a.addClass(this._highlighted_option,"dijitMenuItemSelected");}},_blurOptionNode:function(){if(this._highlighted_option){a.removeClass(this._highlighted_option,"dijitMenuItemSelected");this._highlighted_option=null;}},_highlightNextOption:function(){if(!this.getHighlightedOption()){var d=this.domNode.firstChild;this._focusOptionNode(d.style.display=="none"?d.nextSibling:d);}else{var c=this._highlighted_option.nextSibling;if(c&&c.style.display!="none"){this._focusOptionNode(c);}else{this.highlightFirstOption();}}a.window.scrollIntoView(this._highlighted_option);},highlightFirstOption:function(){var d=this.domNode.firstChild;var c=d.nextSibling;this._focusOptionNode(c.style.display=="none"?d:c);a.window.scrollIntoView(this._highlighted_option);},highlightLastOption:function(){this._focusOptionNode(this.domNode.lastChild.previousSibling);a.window.scrollIntoView(this._highlighted_option);},_highlightPrevOption:function(){if(!this.getHighlightedOption()){var c=this.domNode.lastChild;this._focusOptionNode(c.style.display=="none"?c.previousSibling:c);}else{var d=this._highlighted_option.previousSibling;if(d&&d.style.display!="none"){this._focusOptionNode(d);}else{this.highlightLastOption();}}a.window.scrollIntoView(this._highlighted_option);},_page:function(d){var g=0;var e=this.domNode.scrollTop;var c=a.style(this.domNode,"height");if(!this.getHighlightedOption()){this._highlightNextOption();}while(g<c){if(d){if(!this.getHighlightedOption().previousSibling||this._highlighted_option.previousSibling.style.display=="none"){break;}this._highlightPrevOption();}else{if(!this.getHighlightedOption().nextSibling||this._highlighted_option.nextSibling.style.display=="none"){break;}this._highlightNextOption();}var f=this.domNode.scrollTop;g+=(f-e)*(d?-1:1);e=f;}},pageUp:function(){this._page(true);},pageDown:function(){this._page(false);},getHighlightedOption:function(){var c=this._highlighted_option;return(c&&c.parentNode)?c:null;},handleKey:function(c){switch(c.charOrCode){case a.keys.DOWN_ARROW:this._highlightNextOption();return false;case a.keys.PAGE_DOWN:this.pageDown();return false;case a.keys.UP_ARROW:this._highlightPrevOption();return false;case a.keys.PAGE_UP:this.pageUp();return false;default:return true;}}});a.declare("dijit.form.ComboBox",[b.form.ValidationTextBox,b.form.ComboBoxMixin],{_setValueAttr:function(e,d,c){this._set("item",null);if(!e){e="";}b.form.ValidationTextBox.prototype._setValueAttr.call(this,e,d,c);}});a.declare("dijit.form._ComboBoxDataStore",null,{constructor:function(c){this.root=c;if(c.tagName!="SELECT"&&c.firstChild){c=a.query("select",c);if(c.length>0){c=c[0];}else{this.root.innerHTML="<SELECT>"+this.root.innerHTML+"</SELECT>";c=this.root.firstChild;}this.root=c;}a.query("> option",c).forEach(function(d){d.innerHTML=a.trim(d.innerHTML);});},getValue:function(e,d,c){return(d=="value")?e.value:(e.innerText||e.textContent||"");},isItemLoaded:function(c){return true;},getFeatures:function(){return{"dojo.data.api.Read":true,"dojo.data.api.Identity":true};},_fetchItems:function(e,g,d){if(!e.query){e.query={};}if(!e.query.name){e.query.name="";}if(!e.queryOptions){e.queryOptions={};}var f=a.data.util.filter.patternToRegExp(e.query.name,e.queryOptions.ignoreCase),c=a.query("> option",this.root).filter(function(h){return(h.innerText||h.textContent||"").match(f);});if(e.sort){c.sort(a.data.util.sorter.createSortFunction(e.sort,this));}g(c,e);},close:function(c){return;},getLabel:function(c){return c.innerHTML;},getIdentity:function(c){return a.attr(c,"value");},fetchItemByIdentity:function(c){var d=a.query("> option[value='"+c.identity+"']",this.root)[0];c.onItem(d);},fetchSelectedItem:function(){var c=this.root,d=c.selectedIndex;return typeof d=="number"?a.query("> option:nth-child("+(d!=-1?d+1:1)+")",c)[0]:null;}});a.extend(b.form._ComboBoxDataStore,a.data.util.simpleFetch);return b.form.ComboBox;});