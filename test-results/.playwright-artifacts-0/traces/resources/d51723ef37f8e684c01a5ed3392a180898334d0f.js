define("dijit/_base/focus",["dojo","dijit","dojo/window","dijit/_base/manager"],function(a,b){a.mixin(b,{_curFocus:null,_prevFocus:null,isCollapsed:function(){return b.getBookmark().isCollapsed;},getBookmark:function(){var l,d,j,h=a.doc.selection,g=b._curFocus;if(a.global.getSelection){h=a.global.getSelection();if(h){if(h.isCollapsed){j=g?g.tagName:"";if(j){j=j.toLowerCase();if(j=="textarea"||(j=="input"&&(!g.type||g.type.toLowerCase()=="text"))){h={start:g.selectionStart,end:g.selectionEnd,node:g,pRange:true};return{isCollapsed:(h.end<=h.start),mark:h};}}l={isCollapsed:true};if(h.rangeCount){l.mark=h.getRangeAt(0).cloneRange();}}else{d=h.getRangeAt(0);l={isCollapsed:false,mark:d.cloneRange()};}}}else{if(h){j=g?g.tagName:"";j=j.toLowerCase();if(g&&j&&(j=="button"||j=="textarea"||j=="input")){if(h.type&&h.type.toLowerCase()=="none"){return{isCollapsed:true,mark:null};}else{d=h.createRange();return{isCollapsed:d.text&&d.text.length?false:true,mark:{range:d,pRange:true}};}}l={};try{d=h.createRange();l.isCollapsed=!(h.type=="Text"?d.htmlText.length:d.length);}catch(k){l.isCollapsed=true;return l;}if(h.type.toUpperCase()=="CONTROL"){if(d.length){l.mark=[];var f=0,c=d.length;while(f<c){l.mark.push(d.item(f++));}}else{l.isCollapsed=true;l.mark=null;}}else{l.mark=d.getBookmark();}}else{console.warn("No idea how to store the current selection for this browser!");}}return l;},moveToBookmark:function(d){var g=a.doc,i=d.mark;if(i){if(a.global.getSelection){var f=a.global.getSelection();if(f&&f.removeAllRanges){if(i.pRange){var e=i;var h=e.node;h.selectionStart=e.start;h.selectionEnd=e.end;}else{f.removeAllRanges();f.addRange(i);}}else{console.warn("No idea how to restore selection for this browser!");}}else{if(g.selection&&i){var c;if(i.pRange){c=i.range;}else{if(a.isArray(i)){c=g.body.createControlRange();a.forEach(i,function(j){c.addElement(j);});}else{c=g.body.createTextRange();c.moveToBookmark(i);}}c.select();}}}},getFocus:function(e,c){var d=!b._curFocus||(e&&a.isDescendant(b._curFocus,e.domNode))?b._prevFocus:b._curFocus;return{node:d,bookmark:(d==b._curFocus)&&a.withGlobal(c||a.global,b.getBookmark),openedForWindow:c};},focus:function(g){if(!g){return;}var f="node" in g?g.node:g,d=g.bookmark,c=g.openedForWindow,k=d?d.isCollapsed:false;if(f){var j=(f.tagName.toLowerCase()=="iframe")?f.contentWindow:f;if(j&&j.focus){try{j.focus();}catch(i){}}b._onFocusNode(f);}if(d&&a.withGlobal(c||a.global,b.isCollapsed)&&!k){if(c){c.focus();}try{a.withGlobal(c||a.global,b.moveToBookmark,null,[d]);}catch(h){}}},_activeStack:[],registerIframe:function(c){return b.registerWin(c.contentWindow,c);},unregisterIframe:function(c){b.unregisterWin(c);},registerWin:function(h,c){var e=function(k){b._justMouseDowned=true;setTimeout(function(){b._justMouseDowned=false;},0);if(a.isIE&&k&&k.srcElement&&k.srcElement.parentNode==null){return;}b._onTouchNode(c||k.target||k.srcElement,"mouse");};var j=a.isIE?h.document.documentElement:h.document;if(j){if(a.isIE){h.document.body.attachEvent("onmousedown",e);var g=function(k){if(k.srcElement.tagName.toLowerCase()!="#document"&&b.isTabNavigable(k.srcElement)){b._onFocusNode(c||k.srcElement);}else{b._onTouchNode(c||k.srcElement);}};j.attachEvent("onactivate",g);var d=function(k){b._onBlurNode(c||k.srcElement);};j.attachEvent("ondeactivate",d);return function(){h.document.detachEvent("onmousedown",e);j.detachEvent("onactivate",g);j.detachEvent("ondeactivate",d);j=null;};}else{j.body.addEventListener("mousedown",e,true);var f=function(k){b._onFocusNode(c||k.target);};j.addEventListener("focus",f,true);var i=function(k){b._onBlurNode(c||k.target);};j.addEventListener("blur",i,true);return function(){j.body.removeEventListener("mousedown",e,true);j.removeEventListener("focus",f,true);j.removeEventListener("blur",i,true);j=null;};}}},unregisterWin:function(c){c&&c();},_onBlurNode:function(c){b._prevFocus=b._curFocus;b._curFocus=null;if(b._justMouseDowned){return;}if(b._clearActiveWidgetsTimer){clearTimeout(b._clearActiveWidgetsTimer);}b._clearActiveWidgetsTimer=setTimeout(function(){delete b._clearActiveWidgetsTimer;b._setStack([]);b._prevFocus=null;},100);},_onTouchNode:function(f,i){if(b._clearActiveWidgetsTimer){clearTimeout(b._clearActiveWidgetsTimer);delete b._clearActiveWidgetsTimer;}var c=[];try{while(f){var d=a.attr(f,"dijitPopupParent");if(d){f=b.byId(d).domNode;}else{if(f.tagName&&f.tagName.toLowerCase()=="body"){if(f===a.body()){break;}f=a.window.get(f.ownerDocument).frameElement;}else{var j=f.getAttribute&&f.getAttribute("widgetId"),g=j&&b.byId(j);if(g&&!(i=="mouse"&&g.get("disabled"))){c.unshift(j);}f=f.parentNode;}}}}catch(h){}b._setStack(c,i);},_onFocusNode:function(c){if(!c){return;}if(c.nodeType==9){return;}b._onTouchNode(c);if(c==b._curFocus){return;}if(b._curFocus){b._prevFocus=b._curFocus;}b._curFocus=c;a.publish("focusNode",[c]);},_setStack:function(c,h){var g=b._activeStack;b._activeStack=c;for(var e=0;e<Math.min(g.length,c.length);e++){if(g[e]!=c[e]){break;}}var f;for(var d=g.length-1;d>=e;d--){f=b.byId(g[d]);if(f){f._focused=false;f.set("focused",false);f._hasBeenBlurred=true;if(f._onBlur){f._onBlur(h);}a.publish("widgetBlur",[f,h]);}}for(d=e;d<c.length;d++){f=b.byId(c[d]);if(f){f._focused=true;f.set("focused",true);if(f._onFocus){f._onFocus(h);}a.publish("widgetFocus",[f,h]);}}}});a.addOnLoad(function(){var c=b.registerWin(window);if(a.isIE){a.addOnWindowUnload(function(){b.unregisterWin(c);c=null;});}});return b;});