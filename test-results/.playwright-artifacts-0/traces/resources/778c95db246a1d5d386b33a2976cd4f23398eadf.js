define("dojo/data/ItemFileWriteStore",["dojo","dojo/data/ItemFileReadStore"],function(a){a.declare("dojo.data.ItemFileWriteStore",a.data.ItemFileReadStore,{constructor:function(b){this._features["dojo.data.api.Write"]=true;this._features["dojo.data.api.Notification"]=true;this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};if(!this._datatypeMap.Date.serialize){this._datatypeMap.Date.serialize=function(c){return a.date.stamp.toISOString(c,{zulu:true});};}if(b&&(b.referenceIntegrity===false)){this.referenceIntegrity=false;}this._saveInProgress=false;},referenceIntegrity:true,_assert:function(b){if(!b){throw new Error("assertion failed in ItemFileWriteStore");}},_getIdentifierAttribute:function(){var b=this.getFeatures()["dojo.data.api.Identity"];return b;},newItem:function(n,d){this._assert(!this._saveInProgress);if(!this._loadFinished){this._forceLoad();}if(typeof n!="object"&&typeof n!="undefined"){throw new Error("newItem() was passed something other than an object");}var h=null;var e=this._getIdentifierAttribute();if(e===Number){h=this._arrayOfAllItems.length;}else{h=n[e];if(typeof h==="undefined"){throw new Error("newItem() was not passed an identity for the new item");}if(a.isArray(h)){throw new Error("newItem() was not passed an single-valued identity");}}if(this._itemsByIdentity){this._assert(typeof this._itemsByIdentity[h]==="undefined");}this._assert(typeof this._pending._newItems[h]==="undefined");this._assert(typeof this._pending._deletedItems[h]==="undefined");var f={};f[this._storeRefPropName]=this;f[this._itemNumPropName]=this._arrayOfAllItems.length;if(this._itemsByIdentity){this._itemsByIdentity[h]=f;f[e]=[h];}this._arrayOfAllItems.push(f);var k=null;if(d&&d.parent&&d.attribute){k={item:d.parent,attribute:d.attribute,oldValue:undefined};var m=this.getValues(d.parent,d.attribute);if(m&&m.length>0){var g=m.slice(0,m.length);if(m.length===1){k.oldValue=m[0];}else{k.oldValue=m.slice(0,m.length);}g.push(f);this._setValueOrValues(d.parent,d.attribute,g,false);k.newValue=this.getValues(d.parent,d.attribute);}else{this._setValueOrValues(d.parent,d.attribute,f,false);k.newValue=f;}}else{f[this._rootItemPropName]=true;this._arrayOfTopLevelItems.push(f);}this._pending._newItems[h]=f;for(var l in n){if(l===this._storeRefPropName||l===this._itemNumPropName){throw new Error("encountered bug in ItemFileWriteStore.newItem");}var j=n[l];if(!a.isArray(j)){j=[j];}f[l]=j;if(this.referenceIntegrity){for(var c=0;c<j.length;c++){var b=j[c];if(this.isItem(b)){this._addReferenceToMap(b,f,l);}}}}this.onNew(f,k);return f;},_removeArrayElement:function(d,c){var b=a.indexOf(d,c);if(b!=-1){d.splice(b,1);return true;}return false;},deleteItem:function(j){this._assert(!this._saveInProgress);this._assertIsItem(j);var f=j[this._itemNumPropName];var e=this.getIdentity(j);if(this.referenceIntegrity){var d=this.getAttributes(j);if(j[this._reverseRefMap]){j["backup_"+this._reverseRefMap]=a.clone(j[this._reverseRefMap]);}a.forEach(d,function(l){a.forEach(this.getValues(j,l),function(m){if(this.isItem(m)){if(!j["backupRefs_"+this._reverseRefMap]){j["backupRefs_"+this._reverseRefMap]=[];}j["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(m),attr:l});this._removeReferenceFromMap(m,j,l);}},this);},this);var i=j[this._reverseRefMap];if(i){for(var g in i){var c=null;if(this._itemsByIdentity){c=this._itemsByIdentity[g];}else{c=this._arrayOfAllItems[g];}if(c){for(var b in i[g]){var h=this.getValues(c,b)||[];var k=a.filter(h,function(l){return !(this.isItem(l)&&this.getIdentity(l)==e);},this);this._removeReferenceFromMap(j,c,b);if(k.length<h.length){this._setValueOrValues(c,b,k,true);}}}}}}this._arrayOfAllItems[f]=null;j[this._storeRefPropName]=null;if(this._itemsByIdentity){delete this._itemsByIdentity[e];}this._pending._deletedItems[e]=j;if(j[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,j);}this.onDelete(j);return true;},setValue:function(c,b,d){return this._setValueOrValues(c,b,d,true);},setValues:function(d,c,b){return this._setValueOrValues(d,c,b,true);},unsetAttribute:function(c,b){return this._setValueOrValues(c,b,[],true);},_setValueOrValues:function(p,j,c,f){this._assert(!this._saveInProgress);this._assertIsItem(p);this._assert(a.isString(j));this._assert(typeof c!=="undefined");var b=this._getIdentifierAttribute();if(j==b){throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");}var e=this._getValueOrValues(p,j);var t=this.getIdentity(p);if(!this._pending._modifiedItems[t]){var l={};for(var s in p){if((s===this._storeRefPropName)||(s===this._itemNumPropName)||(s===this._rootItemPropName)){l[s]=p[s];}else{if(s===this._reverseRefMap){l[s]=a.clone(p[s]);}else{l[s]=p[s].slice(0,p[s].length);}}}this._pending._modifiedItems[t]=l;}var h=false;if(a.isArray(c)&&c.length===0){h=delete p[j];c=undefined;if(this.referenceIntegrity&&e){var q=e;if(!a.isArray(q)){q=[q];}for(var n=0;n<q.length;n++){var m=q[n];if(this.isItem(m)){this._removeReferenceFromMap(m,p,j);}}}}else{var g;if(a.isArray(c)){var d=c;g=c.slice(0,c.length);}else{g=[c];}if(this.referenceIntegrity){if(e){var q=e;if(!a.isArray(q)){q=[q];}var r={};a.forEach(q,function(i){if(this.isItem(i)){var u=this.getIdentity(i);r[u.toString()]=true;}},this);a.forEach(g,function(i){if(this.isItem(i)){var u=this.getIdentity(i);if(r[u.toString()]){delete r[u.toString()];}else{this._addReferenceToMap(i,p,j);}}},this);for(var o in r){var k;if(this._itemsByIdentity){k=this._itemsByIdentity[o];}else{k=this._arrayOfAllItems[o];}this._removeReferenceFromMap(k,p,j);}}else{for(var n=0;n<g.length;n++){var m=g[n];if(this.isItem(m)){this._addReferenceToMap(m,p,j);}}}}p[j]=g;h=true;}if(f){this.onSet(p,j,e,c);}return h;},_addReferenceToMap:function(d,b,f){var g=this.getIdentity(b);var e=d[this._reverseRefMap];if(!e){e=d[this._reverseRefMap]={};}var c=e[g];if(!c){c=e[g]={};}c[f]=true;},_removeReferenceFromMap:function(d,b,f){var c=this.getIdentity(b);var e=d[this._reverseRefMap];var g;if(e){for(g in e){if(g==c){delete e[g][f];if(this._isEmpty(e[g])){delete e[g];}}}if(this._isEmpty(e)){delete d[this._reverseRefMap];}}},_dumpReferenceMap:function(){var b;for(b=0;b<this._arrayOfAllItems.length;b++){var c=this._arrayOfAllItems[b];if(c&&c[this._reverseRefMap]){console.log("Item: ["+this.getIdentity(c)+"] is referenced by: "+a.toJson(c[this._reverseRefMap]));}}},_getValueOrValues:function(e,d){var b=undefined;if(this.hasAttribute(e,d)){var c=this.getValues(e,d);if(c.length==1){b=c[0];}else{b=c;}}return b;},_flatten:function(f){if(this.isItem(f)){var e=f;var b=this.getIdentity(e);var d={_reference:b};return d;}else{if(typeof f==="object"){for(var c in this._datatypeMap){var g=this._datatypeMap[c];if(a.isObject(g)&&!a.isFunction(g)){if(f instanceof g.type){if(!g.serialize){throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+c+"]");}return{_type:c,_value:g.serialize(f)};}}else{if(f instanceof g){return{_type:c,_value:f.toString()};}}}}return f;}},_getNewFileContentString:function(){var n={};var f=this._getIdentifierAttribute();if(f!==Number){n.identifier=f;}if(this._labelAttr){n.label=this._labelAttr;}n.items=[];for(var e=0;e<this._arrayOfAllItems.length;++e){var m=this._arrayOfAllItems[e];if(m!==null){var g={};for(var l in m){if(l!==this._storeRefPropName&&l!==this._itemNumPropName&&l!==this._reverseRefMap&&l!==this._rootItemPropName){var b=l;var k=this.getValues(m,b);if(k.length==1){g[b]=this._flatten(k[0]);}else{var h=[];for(var d=0;d<k.length;++d){h.push(this._flatten(k[d]));g[b]=h;}}}}n.items.push(g);}}var c=true;return a.toJson(n,c);},_isEmpty:function(b){var d=true;if(a.isObject(b)){var c;for(c in b){d=false;break;}}else{if(a.isArray(b)){if(b.length>0){d=false;}}}return d;},save:function(c){this._assert(!this._saveInProgress);this._saveInProgress=true;var b=this;var e=function(){b._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};b._saveInProgress=false;if(c&&c.onComplete){var g=c.scope||a.global;c.onComplete.call(g);}};var f=function(h){b._saveInProgress=false;if(c&&c.onError){var g=c.scope||a.global;c.onError.call(g,h);}};if(this._saveEverything){var d=this._getNewFileContentString();this._saveEverything(e,f,d);}if(this._saveCustom){this._saveCustom(e,f);}if(!this._saveEverything&&!this._saveCustom){e();}},revert:function(){this._assert(!this._saveInProgress);var d;for(d in this._pending._modifiedItems){var b=this._pending._modifiedItems[d];var g=null;if(this._itemsByIdentity){g=this._itemsByIdentity[d];}else{g=this._arrayOfAllItems[d];}b[this._storeRefPropName]=this;for(key in g){delete g[key];}a.mixin(g,b);}var c;for(d in this._pending._deletedItems){c=this._pending._deletedItems[d];c[this._storeRefPropName]=this;var e=c[this._itemNumPropName];if(c["backup_"+this._reverseRefMap]){c[this._reverseRefMap]=c["backup_"+this._reverseRefMap];delete c["backup_"+this._reverseRefMap];}this._arrayOfAllItems[e]=c;if(this._itemsByIdentity){this._itemsByIdentity[d]=c;}if(c[this._rootItemPropName]){this._arrayOfTopLevelItems.push(c);}}for(d in this._pending._deletedItems){c=this._pending._deletedItems[d];if(c["backupRefs_"+this._reverseRefMap]){a.forEach(c["backupRefs_"+this._reverseRefMap],function(h){var i;if(this._itemsByIdentity){i=this._itemsByIdentity[h.id];}else{i=this._arrayOfAllItems[h.id];}this._addReferenceToMap(i,c,h.attr);},this);delete c["backupRefs_"+this._reverseRefMap];}}for(d in this._pending._newItems){var f=this._pending._newItems[d];f[this._storeRefPropName]=null;this._arrayOfAllItems[f[this._itemNumPropName]]=null;if(f[this._rootItemPropName]){this._removeArrayElement(this._arrayOfTopLevelItems,f);}if(this._itemsByIdentity){delete this._itemsByIdentity[d];}}this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}};return true;},isDirty:function(c){if(c){var b=this.getIdentity(c);return new Boolean(this._pending._newItems[b]||this._pending._modifiedItems[b]||this._pending._deletedItems[b]).valueOf();}else{if(!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)){return true;}return false;}},onSet:function(d,c,b,e){},onNew:function(c,b){},onDelete:function(b){},close:function(b){if(this.clearOnClose){if(!this.isDirty()){this.inherited(arguments);}else{throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");}}}});return a.data.ItemFileWriteStore;});