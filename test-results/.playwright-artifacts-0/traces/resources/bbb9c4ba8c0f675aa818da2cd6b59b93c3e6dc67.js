define("dojo/data/ItemFileReadStore",["dojo","dojo/data/util/filter","dojo/data/util/simpleFetch","dojo/date/stamp"],function(a){a.declare("dojo.data.ItemFileReadStore",null,{constructor:function(b){this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=false;this._jsonFileUrl=b.url;this._ccUrl=b.url;this.url=b.url;this._jsonData=b.data;this.data=null;this._datatypeMap=b.typeMap||{};if(!this._datatypeMap.Date){this._datatypeMap.Date={type:Date,deserialize:function(c){return a.date.stamp.fromISOString(c);}};}this._features={"dojo.data.api.Read":true,"dojo.data.api.Identity":true};this._itemsByIdentity=null;this._storeRefPropName="_S";this._itemNumPropName="_0";this._rootItemPropName="_RI";this._reverseRefMap="_RRM";this._loadInProgress=false;this._queuedFetches=[];if(b.urlPreventCache!==undefined){this.urlPreventCache=b.urlPreventCache?true:false;}if(b.hierarchical!==undefined){this.hierarchical=b.hierarchical?true:false;}if(b.clearOnClose){this.clearOnClose=true;}if("failOk" in b){this.failOk=b.failOk?true:false;}},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:false,urlPreventCache:false,failOk:false,hierarchical:true,_assertIsItem:function(b){if(!this.isItem(b)){throw new Error("dojo.data.ItemFileReadStore: Invalid item argument.");}},_assertIsAttribute:function(b){if(typeof b!=="string"){throw new Error("dojo.data.ItemFileReadStore: Invalid attribute argument.");}},getValue:function(e,d,b){var c=this.getValues(e,d);return(c.length>0)?c[0]:b;},getValues:function(c,b){this._assertIsItem(c);this._assertIsAttribute(b);return(c[b]||[]).slice(0);},getAttributes:function(d){this._assertIsItem(d);var b=[];for(var c in d){if((c!==this._storeRefPropName)&&(c!==this._itemNumPropName)&&(c!==this._rootItemPropName)&&(c!==this._reverseRefMap)){b.push(c);}}return b;},hasAttribute:function(c,b){this._assertIsItem(c);this._assertIsAttribute(b);return(b in c);},containsValue:function(c,b,e){var d=undefined;if(typeof e==="string"){d=a.data.util.filter.patternToRegExp(e,false);}return this._containsValue(c,b,e,d);},_containsValue:function(c,b,e,d){return a.some(this.getValues(c,b),function(f){if(f!==null&&!a.isObject(f)&&d){if(f.toString().match(d)){return true;}}else{if(e===f){return true;}}});},isItem:function(b){if(b&&b[this._storeRefPropName]===this){if(this._arrayOfAllItems[b[this._itemNumPropName]]===b){return true;}}return false;},isItemLoaded:function(b){return this.isItem(b);},loadItem:function(b){this._assertIsItem(b.item);},getFeatures:function(){return this._features;},getLabel:function(b){if(this._labelAttr&&this.isItem(b)){return this.getValue(b,this._labelAttr);}return undefined;},getLabelAttributes:function(b){if(this._labelAttr){return[this._labelAttr];}return null;},_fetchItems:function(k,i,c){var j=this,b=function(n,q){var p=[],l,s;if(n.query){var r,o=n.queryOptions?n.queryOptions.ignoreCase:false;var t={};for(s in n.query){r=n.query[s];if(typeof r==="string"){t[s]=a.data.util.filter.patternToRegExp(r,o);}else{if(r instanceof RegExp){t[s]=r;}}}for(l=0;l<q.length;++l){var m=true;var e=q[l];if(e===null){m=false;}else{for(s in n.query){r=n.query[s];if(!j._containsValue(e,s,r,t[s])){m=false;}}}if(m){p.push(e);}}i(p,n);}else{for(l=0;l<q.length;++l){var u=q[l];if(u!==null){p.push(u);}}i(p,n);}};if(this._loadFinished){b(k,this._getItemsArray(k.queryOptions));}else{if(this._jsonFileUrl!==this._ccUrl){a.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){if(this._loadInProgress){this._queuedFetches.push({args:k,filter:b});}else{this._loadInProgress=true;var f={url:j._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk};var g=a.xhrGet(f);g.addCallback(function(l){try{j._getItemsFromLoadedData(l);j._loadFinished=true;j._loadInProgress=false;b(k,j._getItemsArray(k.queryOptions));j._handleQueuedFetches();}catch(m){j._loadFinished=true;j._loadInProgress=false;c(m,k);}});g.addErrback(function(e){j._loadInProgress=false;c(e,k);});var h=null;if(k.abort){h=k.abort;}k.abort=function(){var e=g;if(e&&e.fired===-1){e.cancel();e=null;}if(h){h.call(k);}};}}else{if(this._jsonData){try{this._loadFinished=true;this._getItemsFromLoadedData(this._jsonData);this._jsonData=null;b(k,this._getItemsArray(k.queryOptions));}catch(d){c(d,k);}}else{c(new Error("dojo.data.ItemFileReadStore: No JSON source data was provided as either URL or a nested Javascript object."),k);}}}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var d=0;d<this._queuedFetches.length;d++){var b=this._queuedFetches[d],c=b.args,e=b.filter;if(e){e(c,this._getItemsArray(c.queryOptions));}else{this.fetchItemByIdentity(c);}}this._queuedFetches=[];}},_getItemsArray:function(b){if(b&&b.deep){return this._arrayOfAllItems;}return this._arrayOfTopLevelItems;},close:function(b){if(this.clearOnClose&&this._loadFinished&&!this._loadInProgress){if(((this._jsonFileUrl==""||this._jsonFileUrl==null)&&(this.url==""||this.url==null))&&this.data==null){console.debug("dojo.data.ItemFileReadStore: WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch");}this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=false;this._itemsByIdentity=null;this._loadInProgress=false;this._queuedFetches=[];}},_getItemsFromLoadedData:function(f){var g=false,p=this;function c(i){var j=((i!==null)&&(typeof i==="object")&&(!a.isArray(i)||g)&&(!a.isFunction(i))&&(i.constructor==Object||a.isArray(i))&&(typeof i._reference==="undefined")&&(typeof i._type==="undefined")&&(typeof i._value==="undefined")&&p.hierarchical);return j;}function x(D){p._arrayOfAllItems.push(D);for(var C in D){var B=D[C];if(B){if(a.isArray(B)){var A=B;for(var j=0;j<A.length;++j){var i=A[j];if(c(i)){x(i);}}}else{if(c(B)){x(B);}}}}}this._labelAttr=f.label;var u,w;this._arrayOfAllItems=[];this._arrayOfTopLevelItems=f.items;for(u=0;u<this._arrayOfTopLevelItems.length;++u){w=this._arrayOfTopLevelItems[u];if(a.isArray(w)){g=true;}x(w);w[this._rootItemPropName]=true;}var r={},y;for(u=0;u<this._arrayOfAllItems.length;++u){w=this._arrayOfAllItems[u];for(y in w){if(y!==this._rootItemPropName){var q=w[y];if(q!==null){if(!a.isArray(q)){w[y]=[q];}}else{w[y]=[null];}}r[y]=y;}}while(r[this._storeRefPropName]){this._storeRefPropName+="_";}while(r[this._itemNumPropName]){this._itemNumPropName+="_";}while(r[this._reverseRefMap]){this._reverseRefMap+="_";}var m;var e=f.identifier;if(e){this._itemsByIdentity={};this._features["dojo.data.api.Identity"]=e;for(u=0;u<this._arrayOfAllItems.length;++u){w=this._arrayOfAllItems[u];m=w[e];var z=m[0];if(!Object.hasOwnProperty.call(this._itemsByIdentity,z)){this._itemsByIdentity[z]=w;}else{if(this._jsonFileUrl){throw new Error("dojo.data.ItemFileReadStore:  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+e+"].  Value collided: ["+z+"]");}else{if(this._jsonData){throw new Error("dojo.data.ItemFileReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+e+"].  Value collided: ["+z+"]");}}}}}else{this._features["dojo.data.api.Identity"]=Number;}for(u=0;u<this._arrayOfAllItems.length;++u){w=this._arrayOfAllItems[u];w[this._storeRefPropName]=this;w[this._itemNumPropName]=u;}for(u=0;u<this._arrayOfAllItems.length;++u){w=this._arrayOfAllItems[u];for(y in w){m=w[y];for(var t=0;t<m.length;++t){q=m[t];if(q!==null&&typeof q=="object"){if(("_type" in q)&&("_value" in q)){var h=q._type;var l=this._datatypeMap[h];if(!l){throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+h+"'");}else{if(a.isFunction(l)){m[t]=new l(q._value);}else{if(a.isFunction(l.deserialize)){m[t]=l.deserialize(q._value);}else{throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");}}}}if(q._reference){var b=q._reference;if(!a.isObject(b)){m[t]=this._getItemByIdentity(b);}else{for(var s=0;s<this._arrayOfAllItems.length;++s){var d=this._arrayOfAllItems[s],n=true;for(var v in b){if(d[v]!=b[v]){n=false;}}if(n){m[t]=d;}}}if(this.referenceIntegrity){var o=m[t];if(this.isItem(o)){this._addReferenceToMap(o,w,y);}}}else{if(this.isItem(q)){if(this.referenceIntegrity){this._addReferenceToMap(q,w,y);}}}}}}}},_addReferenceToMap:function(c,b,d){},getIdentity:function(c){var b=this._features["dojo.data.api.Identity"];if(b===Number){return c[this._itemNumPropName];}else{var d=c[b];if(d){return d[0];}}return null;},fetchItemByIdentity:function(c){var f,d;if(!this._loadFinished){var b=this;if(this._jsonFileUrl!==this._ccUrl){a.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null&&this._jsonData==null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){if(this._loadInProgress){this._queuedFetches.push({args:c});}else{this._loadInProgress=true;var g={url:b._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk};var e=a.xhrGet(g);e.addCallback(function(j){var i=c.scope?c.scope:a.global;try{b._getItemsFromLoadedData(j);b._loadFinished=true;b._loadInProgress=false;f=b._getItemByIdentity(c.identity);if(c.onItem){c.onItem.call(i,f);}b._handleQueuedFetches();}catch(h){b._loadInProgress=false;if(c.onError){c.onError.call(i,h);}}});e.addErrback(function(h){b._loadInProgress=false;if(c.onError){var i=c.scope?c.scope:a.global;c.onError.call(i,h);}});}}else{if(this._jsonData){b._getItemsFromLoadedData(b._jsonData);b._jsonData=null;b._loadFinished=true;f=b._getItemByIdentity(c.identity);if(c.onItem){d=c.scope?c.scope:a.global;c.onItem.call(d,f);}}}}else{f=this._getItemByIdentity(c.identity);if(c.onItem){d=c.scope?c.scope:a.global;c.onItem.call(d,f);}}},_getItemByIdentity:function(b){var c=null;if(this._itemsByIdentity&&Object.hasOwnProperty.call(this._itemsByIdentity,b)){c=this._itemsByIdentity[b];}else{if(Object.hasOwnProperty.call(this._arrayOfAllItems,b)){c=this._arrayOfAllItems[b];}}if(c===undefined){c=null;}return c;},getIdentityAttributes:function(c){var b=this._features["dojo.data.api.Identity"];if(b===Number){return null;}else{return[b];}},_forceLoad:function(){var b=this;if(this._jsonFileUrl!==this._ccUrl){a.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){var d={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:true};var c=a.xhrGet(d);c.addCallback(function(f){try{if(b._loadInProgress!==true&&!b._loadFinished){b._getItemsFromLoadedData(f);b._loadFinished=true;}else{if(b._loadInProgress){throw new Error("dojo.data.ItemFileReadStore:  Unable to perform a synchronous load, an async load is in progress.");}}}catch(g){console.log(g);throw g;}});c.addErrback(function(e){throw e;});}else{if(this._jsonData){b._getItemsFromLoadedData(b._jsonData);b._jsonData=null;b._loadFinished=true;}}}});a.extend(a.data.ItemFileReadStore,a.data.util.simpleFetch);return a.data.ItemFileReadStore;});