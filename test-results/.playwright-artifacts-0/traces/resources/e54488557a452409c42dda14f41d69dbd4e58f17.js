define("dijit/Editor",["dojo","dijit","dijit/_editor/RichText","dijit/Toolbar","dijit/ToolbarSeparator","dijit/_editor/_Plugin","dijit/_editor/plugins/EnterKeyHandling","dijit/_editor/range","dijit/_Container","dojo/i18n","dijit/layout/_LayoutWidget","i18n!dijit/_editor/nls/commands"],function(a,b){a.declare("dijit.Editor",b._editor.RichText,{plugins:null,extraPlugins:null,constructor:function(){if(!a.isArray(this.plugins)){this.plugins=["undo","redo","|","cut","copy","paste","|","bold","italic","underline","strikethrough","|","insertOrderedList","insertUnorderedList","indent","outdent","|","justifyLeft","justifyRight","justifyCenter","justifyFull","dijit._editor.plugins.EnterKeyHandling"];}this._plugins=[];this._editInterval=this.editActionInterval*1000;if(a.isIE){this.events.push("onBeforeDeactivate");this.events.push("onBeforeActivate");}},postMixInProperties:function(){this.setValueDeferred=new a.Deferred();this.inherited(arguments);},postCreate:function(){this._steps=this._steps.slice(0);this._undoedSteps=this._undoedSteps.slice(0);if(a.isArray(this.extraPlugins)){this.plugins=this.plugins.concat(this.extraPlugins);}this.inherited(arguments);this.commands=a.i18n.getLocalization("dijit._editor","commands",this.lang);if(!this.toolbar){this.toolbar=new b.Toolbar({dir:this.dir,lang:this.lang});this.header.appendChild(this.toolbar.domNode);}a.forEach(this.plugins,this.addPlugin,this);this.setValueDeferred.callback(true);a.addClass(this.iframe.parentNode,"dijitEditorIFrameContainer");a.addClass(this.iframe,"dijitEditorIFrame");a.attr(this.iframe,"allowTransparency",true);if(a.isWebKit){a.style(this.domNode,"KhtmlUserSelect","none");}this.toolbar.startup();this.onNormalizedDisplayChanged();},destroy:function(){a.forEach(this._plugins,function(c){if(c&&c.destroy){c.destroy();}});this._plugins=[];this.toolbar.destroyRecursive();delete this.toolbar;this.inherited(arguments);},addPlugin:function(f,e){var d=a.isString(f)?{name:f}:f;if(!d.setEditor){var g={args:d,plugin:null,editor:this};a.publish(b._scopeName+".Editor.getPlugin",[g]);if(!g.plugin){var c=a.getObject(d.name);if(c){g.plugin=new c(d);}}if(!g.plugin){console.warn("Cannot find plugin",f);return;}f=g.plugin;}if(arguments.length>1){this._plugins[e]=f;}else{this._plugins.push(f);}f.setEditor(this);if(a.isFunction(f.setToolbar)){f.setToolbar(this.toolbar);}},startup:function(){},resize:function(c){if(c){b.layout._LayoutWidget.prototype.resize.apply(this,arguments);}},layout:function(){var c=(this._contentBox.h-(this.getHeaderHeight()+this.getFooterHeight()+a._getPadBorderExtents(this.iframe.parentNode).h+a._getMarginExtents(this.iframe.parentNode).h));this.editingArea.style.height=c+"px";if(this.iframe){this.iframe.style.height="100%";}this._layoutMode=true;},_onIEMouseDown:function(h){var k;var j=this.document.body;var l=j.clientWidth;var f=j.clientHeight;var g=j.clientLeft;var i=j.offsetWidth;var c=j.offsetHeight;var d=j.offsetLeft;bodyDir=j.dir?j.dir.toLowerCase():"";if(bodyDir!="rtl"){if(l<i&&h.x>l&&h.x<i){k=true;}}else{if(h.x<g&&h.x>d){k=true;}}if(!k){if(f<c&&h.y>f&&h.y<c){k=true;}}if(!k){delete this._cursorToStart;delete this._savedSelection;if(h.target.tagName=="BODY"){setTimeout(a.hitch(this,"placeCursorAtEnd"),0);}this.inherited(arguments);}},onBeforeActivate:function(c){this._restoreSelection();},onBeforeDeactivate:function(c){if(this.customUndo){this.endEditing(true);}if(c.target.tagName!="BODY"){this._saveSelection();}},customUndo:true,editActionInterval:3,beginEditing:function(c){if(!this._inEditing){this._inEditing=true;this._beginEditing(c);}if(this.editActionInterval>0){if(this._editTimer){clearTimeout(this._editTimer);}this._editTimer=setTimeout(a.hitch(this,this.endEditing),this._editInterval);}},_steps:[],_undoedSteps:[],execCommand:function(g){if(this.customUndo&&(g=="undo"||g=="redo")){return this[g]();}else{if(this.customUndo){this.endEditing();this._beginEditing();}var f;var i=/copy|cut|paste/.test(g);try{f=this.inherited(arguments);if(a.isWebKit&&i&&!f){throw {code:1011};}}catch(h){if(h.code==1011&&i){var d=a.string.substitute,c={cut:"X",copy:"C",paste:"V"};alert(d(this.commands.systemShortcut,[this.commands[g],d(this.commands[a.isMac?"appleKey":"ctrlKey"],[c[g]])]));}f=false;}if(this.customUndo){this._endEditing();}return f;}},queryCommandEnabled:function(c){if(this.customUndo&&(c=="undo"||c=="redo")){return c=="undo"?(this._steps.length>1):(this._undoedSteps.length>0);}else{return this.inherited(arguments);}},_moveToBookmark:function(d){var g=d.mark;var j=d.mark;var e=d.isCollapsed;var h,c,f,i;if(j){if(a.isIE<9){if(a.isArray(j)){g=[];a.forEach(j,function(k){g.push(b.range.getNode(k,this.editNode));},this);a.withGlobal(this.window,"moveToBookmark",b,[{mark:g,isCollapsed:e}]);}else{if(j.startContainer&&j.endContainer){i=b.range.getSelection(this.window);if(i&&i.removeAllRanges){i.removeAllRanges();h=b.range.create(this.window);c=b.range.getNode(j.startContainer,this.editNode);f=b.range.getNode(j.endContainer,this.editNode);if(c&&f){h.setStart(c,j.startOffset);h.setEnd(f,j.endOffset);i.addRange(h);}}}}}else{i=b.range.getSelection(this.window);if(i&&i.removeAllRanges){i.removeAllRanges();h=b.range.create(this.window);c=b.range.getNode(j.startContainer,this.editNode);f=b.range.getNode(j.endContainer,this.editNode);if(c&&f){h.setStart(c,j.startOffset);h.setEnd(f,j.endOffset);i.addRange(h);}}}}},_changeToStep:function(e,d){this.setValue(d.text);var c=d.bookmark;if(!c){return;}this._moveToBookmark(c);},undo:function(){var c=false;if(!this._undoRedoActive){this._undoRedoActive=true;this.endEditing(true);var d=this._steps.pop();if(d&&this._steps.length>0){this.focus();this._changeToStep(d,this._steps[this._steps.length-1]);this._undoedSteps.push(d);this.onDisplayChanged();delete this._undoRedoActive;c=true;}delete this._undoRedoActive;}return c;},redo:function(){var c=false;if(!this._undoRedoActive){this._undoRedoActive=true;this.endEditing(true);var d=this._undoedSteps.pop();if(d&&this._steps.length>0){this.focus();this._changeToStep(this._steps[this._steps.length-1],d);this._steps.push(d);this.onDisplayChanged();c=true;}delete this._undoRedoActive;}return c;},endEditing:function(c){if(this._editTimer){clearTimeout(this._editTimer);}if(this._inEditing){this._endEditing(c);this._inEditing=false;}},_getBookmark:function(){var c=a.withGlobal(this.window,b.getBookmark);var f=[];if(c&&c.mark){var i=c.mark;if(a.isIE<9){var g=b.range.getSelection(this.window);if(!a.isArray(i)){if(g){var d;if(g.rangeCount){d=g.getRangeAt(0);}if(d){c.mark=d.cloneRange();}else{c.mark=a.withGlobal(this.window,b.getBookmark);}}}else{a.forEach(c.mark,function(e){f.push(b.range.getIndex(e,this.editNode).o);},this);c.mark=f;}}try{if(c.mark&&c.mark.startContainer){f=b.range.getIndex(c.mark.startContainer,this.editNode).o;c.mark={startContainer:f,startOffset:c.mark.startOffset,endContainer:c.mark.endContainer===c.mark.startContainer?f:b.range.getIndex(c.mark.endContainer,this.editNode).o,endOffset:c.mark.endOffset};}}catch(h){c.mark=null;}}return c;},_beginEditing:function(c){if(this._steps.length===0){this._steps.push({text:b._editor.getChildrenHtml(this.editNode),bookmark:this._getBookmark()});}},_endEditing:function(d){var c=b._editor.getChildrenHtml(this.editNode);this._undoedSteps=[];this._steps.push({text:c,bookmark:this._getBookmark()});},onKeyDown:function(d){if(!a.isIE&&!this.iframe&&d.keyCode==a.keys.TAB&&!this.tabIndent){this._saveSelection();}if(!this.customUndo){this.inherited(arguments);return;}var c=d.keyCode,f=a.keys;if(d.ctrlKey&&!d.altKey){if(c==90||c==122){a.stopEvent(d);this.undo();return;}else{if(c==89||c==121){a.stopEvent(d);this.redo();return;}}}this.inherited(arguments);switch(c){case f.ENTER:case f.BACKSPACE:case f.DELETE:this.beginEditing();break;case 88:case 86:if(d.ctrlKey&&!d.altKey&&!d.metaKey){this.endEditing();if(d.keyCode==88){this.beginEditing("cut");setTimeout(a.hitch(this,this.endEditing),1);}else{this.beginEditing("paste");setTimeout(a.hitch(this,this.endEditing),1);}break;}default:if(!d.ctrlKey&&!d.altKey&&!d.metaKey&&(d.keyCode<a.keys.F1||d.keyCode>a.keys.F15)){this.beginEditing();break;}case f.ALT:this.endEditing();break;case f.UP_ARROW:case f.DOWN_ARROW:case f.LEFT_ARROW:case f.RIGHT_ARROW:case f.HOME:case f.END:case f.PAGE_UP:case f.PAGE_DOWN:this.endEditing(true);break;case f.CTRL:case f.SHIFT:case f.TAB:break;}},_onBlur:function(){this.inherited(arguments);this.endEditing(true);},_saveSelection:function(){try{this._savedSelection=this._getBookmark();}catch(c){}},_restoreSelection:function(){if(this._savedSelection){delete this._cursorToStart;if(a.withGlobal(this.window,"isCollapsed",b)){this._moveToBookmark(this._savedSelection);}delete this._savedSelection;}},onClick:function(){this.endEditing(true);this.inherited(arguments);},replaceValue:function(c){if(!this.customUndo){this.inherited(arguments);}else{if(this.isClosed){this.setValue(c);}else{this.beginEditing();if(!c){c="&nbsp;";}this.setValue(c);this.endEditing();}}},_setDisabledAttr:function(d){var c=a.hitch(this,function(){if((!this.disabled&&d)||(!this._buttonEnabledPlugins&&d)){a.forEach(this._plugins,function(e){e.set("disabled",true);});}else{if(this.disabled&&!d){a.forEach(this._plugins,function(e){e.set("disabled",false);});}}});this.setValueDeferred.addCallback(c);this.inherited(arguments);},_setStateClass:function(){try{this.inherited(arguments);if(this.document&&this.document.body){a.style(this.document.body,"color",a.style(this.iframe,"color"));}}catch(c){}}});a.subscribe(b._scopeName+".Editor.getPlugin",null,function(g){if(g.plugin){return;}var e=g.args,f;var c=b._editor._Plugin;var d=e.name;switch(d){case"undo":case"redo":case"cut":case"copy":case"paste":case"insertOrderedList":case"insertUnorderedList":case"indent":case"outdent":case"justifyCenter":case"justifyFull":case"justifyLeft":case"justifyRight":case"delete":case"selectAll":case"removeFormat":case"unlink":case"insertHorizontalRule":f=new c({command:d});break;case"bold":case"italic":case"underline":case"strikethrough":case"subscript":case"superscript":f=new c({buttonClass:b.form.ToggleButton,command:d});break;case"|":f=new c({button:new b.ToolbarSeparator(),setEditor:function(h){this.editor=h;}});}g.plugin=f;});return b.Editor;});