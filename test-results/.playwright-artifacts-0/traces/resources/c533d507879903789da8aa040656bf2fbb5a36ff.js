define("dijit/tree/TreeStoreModel",["dojo","dijit"],function(a,b){a.declare("dijit.tree.TreeStoreModel",null,{store:null,childrenAttrs:["children"],newItemIdAttr:"id",labelAttr:"",root:null,query:null,deferItemLoadingUntilExpand:false,constructor:function(d){a.mixin(this,d);this.connects=[];var c=this.store;if(!c.getFeatures()["dojo.data.api.Identity"]){throw new Error("dijit.Tree: store must support dojo.data.Identity");}if(c.getFeatures()["dojo.data.api.Notification"]){this.connects=this.connects.concat([a.connect(c,"onNew",this,"onNewItem"),a.connect(c,"onDelete",this,"onDeleteItem"),a.connect(c,"onSet",this,"onSetItem")]);}},destroy:function(){a.forEach(this.connects,a.disconnect);},getRoot:function(c,d){if(this.root){c(this.root);}else{this.store.fetch({query:this.query,onComplete:a.hitch(this,function(e){if(e.length!=1){throw new Error(this.declaredClass+": query "+a.toJson(this.query)+" returned "+e.length+" items, but must return exactly one item");}this.root=e[0];c(this.root);}),onError:d});}},mayHaveChildren:function(c){return a.some(this.childrenAttrs,function(d){return this.store.hasAttribute(c,d);},this);},getChildren:function(c,d,g){var k=this.store;if(!k.isItemLoaded(c)){var h=a.hitch(this,arguments.callee);k.loadItem({item:c,onItem:function(i){h(i,d,g);},onError:g});return;}var f=[];for(var e=0;e<this.childrenAttrs.length;e++){var j=k.getValues(c,this.childrenAttrs[e]);f=f.concat(j);}var l=0;if(!this.deferItemLoadingUntilExpand){a.forEach(f,function(i){if(!k.isItemLoaded(i)){l++;}});}if(l==0){d(f);}else{a.forEach(f,function(m,i){if(!k.isItemLoaded(m)){k.loadItem({item:m,onItem:function(n){f[i]=n;if(--l==0){d(f);}},onError:g});}});}},isItem:function(c){return this.store.isItem(c);},fetchItemByIdentity:function(c){this.store.fetchItemByIdentity(c);},getIdentity:function(c){return this.store.getIdentity(c);},getLabel:function(c){if(this.labelAttr){return this.store.getValue(c,this.labelAttr);}else{return this.store.getLabel(c);}},newItem:function(d,e,c){var f={parent:e,attribute:this.childrenAttrs[0]},g;if(this.newItemIdAttr&&d[this.newItemIdAttr]){this.fetchItemByIdentity({identity:d[this.newItemIdAttr],scope:this,onItem:function(h){if(h){this.pasteItem(h,null,e,true,c);}else{g=this.store.newItem(d,f);if(g&&(c!=undefined)){this.pasteItem(g,e,e,false,c);}}}});}else{g=this.store.newItem(d,f);if(g&&(c!=undefined)){this.pasteItem(g,e,e,false,c);}}},pasteItem:function(g,f,j,d,c){var e=this.store,h=this.childrenAttrs[0];if(f){a.forEach(this.childrenAttrs,function(k){if(e.containsValue(f,k,g)){if(!d){var l=a.filter(e.getValues(f,k),function(m){return m!=g;});e.setValues(f,k,l);}h=k;}});}if(j){if(typeof c=="number"){var i=e.getValues(j,h).slice();i.splice(c,0,g);e.setValues(j,h,i);}else{e.setValues(j,h,e.getValues(j,h).concat(g));}}},onChange:function(c){},onChildrenChange:function(d,c){},onDelete:function(d,c){},onNewItem:function(d,c){if(!c){return;}this.getChildren(c.item,a.hitch(this,function(e){this.onChildrenChange(c.item,e);}));},onDeleteItem:function(c){this.onDelete(c);},onSetItem:function(e,d,c,f){if(a.indexOf(this.childrenAttrs,d)!=-1){this.getChildren(e,a.hitch(this,function(g){this.onChildrenChange(e,g);}));}else{this.onChange(e);}}});return b.tree.TreeStoreModel;});